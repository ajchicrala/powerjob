CREATE DATABASE `powerjob` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;

-- powerjob.eventoscoupa definição
-------------------------------------------------------------------------

CREATE TABLE eventoscoupa (
  idevento INT NOT NULL,
  link VARCHAR(255) NOT NULL,
  dtinicio DATE NOT NULL,
  dtfim DATE NOT NULL,
  dtinsercao DATE NOT NULL DEFAULT (CURDATE()),
  cotacao_incluida TINYINT(1) NOT NULL DEFAULT 0,

  PRIMARY KEY (idevento),

  KEY idx_dtinicio (dtinicio),
  KEY idx_dtfim (dtfim),
  KEY idx_cotacao_incluida (cotacao_incluida)

) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_0900_ai_ci;



-- powerjob.cotacoescoupa definição
-------------------------------------------------------------------------

CREATE TABLE cotacoescoupa (
  idcotacao INT NOT NULL,
  idevento INT NOT NULL,

  descricao TEXT,
  quantidade DECIMAL(10,0),
  dtinicio DATE,
  dtfim DATE,
  localentrega TEXT,
  detalhes TEXT,
  valorcotacao DECIMAL(10,0),
  responsavel VARCHAR(100),
  dtcotacao DATE,
  status TINYINT NOT NULL DEFAULT 0,

  PRIMARY KEY (idcotacao),

  KEY idx_idevento (idevento),
  KEY idx_dtinicio (dtinicio),
  KEY idx_dtcotacao (dtcotacao),
  KEY idx_status (status),
  KEY idx_responsavel (responsavel),

  CONSTRAINT fk_cotacoescoupa_evento
    FOREIGN KEY (idevento)
    REFERENCES eventoscoupa (idevento)
    ON UPDATE CASCADE
    ON DELETE RESTRICT

) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_0900_ai_ci;

-------------------------------------------------------------------------
CREATE TABLE empresas (
  idempresa INT NOT NULL AUTO_INCREMENT,

  nome VARCHAR(150) NOT NULL,
  telefone VARCHAR(20),
  documento VARCHAR(20),
  responsavel VARCHAR(150),
  email VARCHAR(150),

  stativa TINYINT(1) NOT NULL DEFAULT 1,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtatualizacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
                    ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idempresa),

  UNIQUE KEY uk_empresas_documento (documento),
  KEY idx_empresas_nome (nome),
  KEY idx_empresas_email (email),
  KEY idx_empresas_stativa (stativa)

) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_0900_ai_ci;


--------------------------------------------------------------------------
CREATE TABLE empresas_usuarios (
  idusuario INT NOT NULL AUTO_INCREMENT,
  idempresa INT NOT NULL,
  idtipo INT NOT NULL,

  nome VARCHAR(150) NOT NULL,
  email VARCHAR(150) NOT NULL,
  senha_hash CHAR(400) NOT NULL,

  stativo TINYINT(1) NOT NULL DEFAULT 1,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtatualizacao DATETIME NOT NULL
      DEFAULT CURRENT_TIMESTAMP
      ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idusuario),

  KEY idx_empresas_usuarios_empresa (idempresa),
  KEY idx_empresas_usuarios_tipo (idtipo),
  KEY idx_empresas_usuarios_stativo (stativo),

  CONSTRAINT fk_empresas_usuarios_empresa
    FOREIGN KEY (idempresa)
    REFERENCES empresas (idempresa)
    ON UPDATE CASCADE
    ON DELETE RESTRICT,

  CONSTRAINT fk_empresas_usuarios_tipo
    FOREIGN KEY (idtipo)
    REFERENCES usuarios_tipo (idtipo)
    ON UPDATE CASCADE
    ON DELETE RESTRICT
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;



--------------------------------------------------------------------------
CREATE TABLE usuarios_tipo (
  idtipo INT NOT NULL AUTO_INCREMENT,

  descricao VARCHAR(100) NOT NULL,

  stativo TINYINT(1) NOT NULL DEFAULT 1,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtatualizacao DATETIME NOT NULL
      DEFAULT CURRENT_TIMESTAMP
      ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idtipo)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;


INSERT INTO usuarios_tipo (descricao, stativo)
VALUES
  ('Administrador', 1),
  ('Cotador', 1);



---------------------------------------------------------------------------
CREATE TABLE tipo_cotacoes (
  idtipocotacao INT NOT NULL AUTO_INCREMENT,
  nome VARCHAR(100) NOT NULL,
  stativo TINYINT(1) NOT NULL DEFAULT 1,
  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtexclusao DATETIME NULL,

  PRIMARY KEY (idtipocotacao)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;


---------------------------------------------------------------------------
CREATE TABLE cotacoes_status (
  idstatus INT NOT NULL AUTO_INCREMENT,
  nome VARCHAR(100) NOT NULL,
  stativo TINYINT(1) NOT NULL DEFAULT 1,
  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtatualizacao DATETIME NOT NULL
      DEFAULT CURRENT_TIMESTAMP
      ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idstatus)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;

INSERT INTO cotacoes_status (nome, stativo)
VALUES
  ('Inicial', 1),
  ('Em cotação', 1),
  ('Realizada', 1),
  ('Cancelada', 1);


----------------------------------------------------------------------------
CREATE TABLE empresas_eventos (
  idempresa INT NOT NULL,
  idevento INT NOT NULL,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (idempresa, idevento),

  KEY idx_empresa_eventos_empresa (idempresa),
  KEY idx_empresa_eventos_evento (idevento),

  CONSTRAINT fk_empresa_eventos_empresa
    FOREIGN KEY (idempresa)
    REFERENCES empresas (idempresa)
    ON UPDATE CASCADE
    ON DELETE RESTRICT,

  CONSTRAINT fk_empresa_eventos_evento
    FOREIGN KEY (idevento)
    REFERENCES eventoscoupa (idevento)
    ON UPDATE CASCADE
    ON DELETE RESTRICT
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;


---------------------------------------------------------------------------
CREATE TABLE portais (
  idportal INT NOT NULL AUTO_INCREMENT,

  nome VARCHAR(150) NOT NULL,

  stativo TINYINT(1) NOT NULL DEFAULT 1,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtatualizacao DATETIME NOT NULL
      DEFAULT CURRENT_TIMESTAMP
      ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idportal)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;

INSERT INTO portais (nome, stativo)
VALUES ('Coupa', 1);


----------------------------------------------------------------------------
CREATE TABLE portais_usuarios (
  idportalusuario INT NOT NULL AUTO_INCREMENT,
  idempresa INT NOT NULL,
  idportal INT NOT NULL,

  login VARCHAR(150) NOT NULL,
  senha_hash CHAR(60) NOT NULL,

  stativo TINYINT(1) NOT NULL DEFAULT 1,

  dtcriacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  dtutilizacao DATETIME NULL,

  PRIMARY KEY (idportalusuario),

  KEY idx_portais_usuarios_empresa (idempresa),
  KEY idx_portais_usuarios_portal (idportal),
  KEY idx_portais_usuarios_stativo (stativo)

)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_unicode_ci;


ALTER TABLE portais_usuarios
ADD CONSTRAINT fk_portais_usuarios_empresa
FOREIGN KEY (idempresa)
REFERENCES empresas (idempresa)
ON UPDATE CASCADE
ON DELETE RESTRICT;


ALTER TABLE portais_usuarios
ADD CONSTRAINT fk_portais_usuarios_portal
FOREIGN KEY (idportal)
REFERENCES portais (idportal)
ON UPDATE CASCADE
ON DELETE RESTRICT;


------------------------------------------------------------------------------
ALTER TABLE portais
ADD COLUMN login_url VARCHAR(255) NULL
AFTER nome;

UPDATE portais
SET login_url = 'https://vale.coupahost.com/sessions/supplier_login'
WHERE idportal = 1;


------------------------------------------------------------------------------
ALTER TABLE empresas_eventos
ADD COLUMN idportal INT NOT NULL;

ALTER TABLE empresas_eventos
ADD CONSTRAINT fk_empresas_eventos_portal
FOREIGN KEY (idportal)
REFERENCES portais (idportal)
ON UPDATE CASCADE
ON DELETE RESTRICT;

ALTER TABLE empresas_eventos
DROP PRIMARY KEY;

ALTER TABLE empresas_eventos
ADD PRIMARY KEY (idempresa, idevento, idportal);


